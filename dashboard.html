<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AQHSA SHOFIA - Dashboard Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f5f8;
      }
      .sidebar {
        width: 256px;
        min-width: 256px;
      }
      .content {
        flex-grow: 1;
      }
      .card {
        box-shadow: 0 4px 6px -1-px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-radius: 12px;
      }
      .chart-container {
        position: relative;
        height: 400px; /* Default height for charts */
        width: 100%;
      }
      .tab-button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
      }
      .tab-button.active {
        background-color: #4f46e5; /* indigo-600 */
        color: white;
      }
      .tab-button:not(.active):hover {
        background-color: #e0e7ff; /* indigo-100 */
        color: #4338ca; /* indigo-700 */
      }
    </style>
  </head>
  <body class="flex flex-col min-h-screen">
    <!-- Header -->
    <header
      class="bg-white shadow-sm py-4 px-6 flex items-center justify-between lg:justify-start lg:space-x-4 z-10 sticky top-0"
    >
      <button
        id="sidebar-toggle-btn"
        class="lg:hidden p-2 rounded-md text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500"
      >
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          ></path>
        </svg>
      </button>
      <h1 class="text-2xl font-bold text-gray-800">AQHSA SHOFIA - HRIS</h1>
      <div class="flex items-center space-x-4 ml-auto">
        <svg
          class="h-6 w-6 text-gray-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
          ></path>
        </svg>
        <div class="relative">
          <img
            src="https://placehold.co/40x40/94a3b8/ffffff?text=U"
            alt="User"
            class="w-10 h-10 rounded-full cursor-pointer"
          />
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="sidebar bg-white p-6 overflow-y-auto border-r border-gray-200 fixed lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-20"
      >
        <div class="flex items-center space-x-2 mb-8">
          <span class="text-xl font-bold">ONLY FOR CACA</span>
        </div>
        <nav class="space-y-4">
          <a
            href="dashboard.html"
            class="flex items-center space-x-3 p-3 rounded-lg bg-indigo-500 text-white font-semibold"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              ></path>
            </svg>
            <span>Dashboard</span>
          </a>
          <a
            href="employee.html"
            class="flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-indigo-100 hover:text-indigo-700"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4.354a4 4 0 110 5.292M15 21H9a6 6 0 01-6-6v-1a6 6 0 016-6h6a6 6 0 016 6v1a6 6 0 01-6 6z"
              ></path>
            </svg>
            <span>Employee</span>
          </a>
          <a
            href="reporting.html"
            class="flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-indigo-100 hover:text-indigo-700"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 4h4a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm0 0H7a2 2 0 01-2-2v-6a2 2 0 012-2h2a2 2 0 012 2v6a2 2 0 01-2 2z"
              ></path>
            </svg>
            <span>Reporting</span>
          </a>
          <a
            href="leave.html"
            class="flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-indigo-100 hover:text-indigo-700"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-4 8v.01M12 12v.01M12 16v.01M3 20h18M3 10h18a2 2 0 012 2v4a2 2 0 01-2 2H3a2 2 0 01-2-2v-4a2 2 0 012-2z"
              ></path>
            </svg>
            <span>Leave</span>
          </a>
          <a
            href="recruitment.html"
            class="flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-indigo-100 hover:text-indigo-700"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-2 0h-2m-2 0V3m-2 2h2m0 0h2m-2 0v2m4-2h2m-2 0v2"
              ></path>
            </svg>
            <span>Recruitment Process</span>
          </a>
          <a
            href="generate_letter.html"
            class="flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-indigo-100 hover:text-indigo-700"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m-6 4h6m-6-4h.01M12 4v4m0 0h.01M12 8h-2m2 0h2m-2 0v-2m-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2m-2 0H9a2 2 0 00-2 2v4a2 2 0 002 2h6a2 2 0 002-2v-4a2 2 0 00-2-2z"
              ></path>
            </svg>
            <span>Generate Letter</span>
          </a>
          <a
            href="surat_peringatan.html"
            class="flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-indigo-100 hover:text-indigo-700"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6 5h12a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z"
              ></path>
            </svg>
            <span>Surat Peringatan</span>
          </a>
          <div class="pt-4 border-t border-gray-200">
            <a
              href="settings.html"
              class="flex items-center space-x-3 p-3 rounded-lg text-gray-600 hover:bg-indigo-100 hover:text-indigo-700"
            >
              <svg
                class="h-5 w-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m-6 4H4m-2 4h16a2 2 0 002-2v-4a2 2 0 00-2-2H4a2 2 0 00-2 2v4a2 2 0 002 2z"
                ></path>
              </svg>
              <span>Settings</span>
            </a>
          </div>
        </nav>
      </aside>

      <div
        id="sidebar-backdrop"
        class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden lg:hidden"
      ></div>

      <!-- Main Content Area -->
      <main class="content p-6 overflow-y-auto">
        <div class="flex items-center justify-between mb-2">
          <h2 id="page-title" class="text-2xl font-bold text-gray-800">
            Dashboard Karyawan
          </h2>
        </div>
        <p id="last-updated-text" class="text-xs text-gray-500 mb-4"></p>

        <!-- Tab Navigation -->
        <div class="flex space-x-4 mb-6 border-b border-gray-200">
          <button
            id="tab-karyawan"
            class="tab-button active"
            onclick="showTab('karyawan')"
          >
            Data Karyawan
          </button>
          <button
            id="tab-surat-peringatan"
            class="tab-button"
            onclick="showTab('surat-peringatan')"
          >
            Surat Peringatan
          </button>
        </div>

        <div
          id="loading-indicator"
          class="text-center py-8 text-gray-500 hidden"
        >
          Memuat data...
        </div>

        <!-- Content for Data Karyawan Tab -->
        <div
          id="karyawan-content"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          <!-- Chart for MARITAL STATUS -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Status Pernikahan
            </h3>
            <div class="chart-container">
              <canvas id="maritalStatusChart"></canvas>
            </div>
          </div>

          <!-- Chart for GENDER -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Jenis Kelamin
            </h3>
            <div class="chart-container">
              <canvas id="genderChart"></canvas>
            </div>
          </div>

          <!-- Chart for RELIGION -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Agama</h3>
            <div class="chart-container">
              <canvas id="religionChart"></canvas>
            </div>
          </div>

          <!-- Chart for GRADE -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Grade</h3>
            <div class="chart-container">
              <canvas id="gradeChart"></canvas>
            </div>
          </div>

          <!-- Chart for DEPARTMENT -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Departemen</h3>
            <div class="chart-container">
              <canvas id="departmentChart"></canvas>
            </div>
          </div>

          <!-- Chart for POSITION -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Posisi</h3>
            <div class="chart-container">
              <canvas id="positionChart"></canvas>
            </div>
          </div>

          <!-- Chart for EDUCATION -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Pendidikan</h3>
            <div class="chart-container">
              <canvas id="educationChart"></canvas>
            </div>
          </div>

          <!-- Chart for POH -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">POH</h3>
            <div class="chart-container">
              <canvas id="pohChart"></canvas>
            </div>
          </div>

          <!-- Chart for STATUS POH -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Status POH</h3>
            <div class="chart-container">
              <canvas id="statusPohChart"></canvas>
            </div>
          </div>

          <!-- Chart for PROVINCE -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Provinsi</h3>
            <div class="chart-container">
              <canvas id="provinceChart"></canvas>
            </div>
          </div>

          <!-- Chart for HIRING DATE (e.g., by year) -->
          <div class="bg-white p-4 rounded-xl card col-span-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Tanggal Bergabung
            </h3>
            <div class="flex space-x-2 mb-4">
              <button
                id="hiringDateYearBtn"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"
              >
                Tahun
              </button>
              <button
                id="hiringDateMonthBtn"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"
              >
                Bulan
              </button>
            </div>
            <div class="chart-container">
              <canvas id="hiringDateChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Content for Surat Peringatan Tab -->
        <div
          id="surat-peringatan-content"
          class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          <!-- Chart for DEPARTMENT SP -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Departemen (SP)
            </h3>
            <div class="chart-container">
              <canvas id="departmentSPChart"></canvas>
            </div>
          </div>

          <!-- Chart for POSITION SP -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Posisi (SP)
            </h3>
            <div class="chart-container">
              <canvas id="positionSPChart"></canvas>
            </div>
          </div>

          <!-- Chart for SANKSI SP -->
          <div class="bg-white p-4 rounded-xl card">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Sanksi (SP)
            </h3>
            <div class="chart-container">
              <canvas id="sanksiSPChart"></canvas>
            </div>
          </div>

          <!-- Chart for TANGGAL KEJADIAN SP (Time Chart) -->
          <div class="bg-white p-4 rounded-xl card col-span-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              Tanggal Kejadian (SP)
            </h3>
            <div class="flex space-x-2 mb-4">
              <button
                id="tanggalKejadianYearBtn"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"
              >
                Tahun
              </button>
              <button
                id="tanggalKejadianMonthBtn"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"
              >
                Bulan
              </button>
            </div>
            <div class="chart-container">
              <canvas id="tanggalKejadianSPChart"></canvas>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast-notification"
      class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-xl hidden transition-opacity duration-300"
    ></div>

    <!-- Footer -->
    <footer
      class="bg-white py-4 px-6 text-center text-sm text-gray-500 border-t border-gray-200 mt-auto"
    >
      DEVELOP BY KAK AFA
    </footer>

    <script>
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwL0IjiReteHPDgmnKjNdU_vXxcZUERrPByQmcjJpd11NhAVIo0QM3XWuXa2ZyJaiSo/exec";

      let employeeData = [];
      let violationData = [];
      let isLoading = false;
      let activeTab = "karyawan"; // Default active tab

      let charts = {}; // To store chart instances for destruction

      let currentHiringDateView = "year"; // 'year' or 'month'
      let currentTanggalKejadianView = "year"; // 'year' or 'month'

      // DOM elements
      const sidebar = document.getElementById("sidebar");
      const sidebarToggleBtn = document.getElementById("sidebar-toggle-btn");
      const sidebarBackdrop = document.getElementById("sidebar-backdrop");
      const lastUpdatedText = document.getElementById("last-updated-text");
      const toastNotification = document.getElementById("toast-notification");
      const loadingIndicator = document.getElementById("loading-indicator");
      const mainContent = document.querySelector("main");

      // Tab elements
      const tabKaryawanBtn = document.getElementById("tab-karyawan");
      const tabSuratPeringatanBtn = document.getElementById(
        "tab-surat-peringatan"
      );
      const karyawanContent = document.getElementById("karyawan-content");
      const suratPeringatanContent = document.getElementById(
        "surat-peringatan-content"
      );

      // Hiring Date View buttons
      const hiringDateYearBtn = document.getElementById("hiringDateYearBtn");
      const hiringDateMonthBtn = document.getElementById("hiringDateMonthBtn");

      // Tanggal Kejadian View buttons
      const tanggalKejadianYearBtn = document.getElementById(
        "tanggalKejadianYearBtn"
      );
      const tanggalKejadianMonthBtn = document.getElementById(
        "tanggalKejadianMonthBtn"
      );

      function showSidebar() {
        sidebar.classList.remove("-translate-x-full");
        sidebar.classList.add("translate-x-0");
        sidebarBackdrop.classList.remove("hidden");
      }

      function hideSidebar() {
        sidebar.classList.remove("translate-x-0");
        sidebar.classList.add("-translate-x-full");
        sidebarBackdrop.classList.add("hidden");
      }

      function showToast(message, duration = 3000) {
        toastNotification.textContent = message;
        toastNotification.classList.remove("hidden", "opacity-0");
        toastNotification.classList.add("opacity-100");
        setTimeout(() => {
          toastNotification.classList.remove("opacity-100");
          toastNotification.classList.add("opacity-0");
          setTimeout(() => {
            toastNotification.classList.add("hidden");
          }, 300);
        }, duration);
      }

      function showLoading() {
        isLoading = true;
        mainContent.classList.add("opacity-50", "pointer-events-none");
        loadingIndicator.classList.remove("hidden");
      }

      function hideLoading() {
        isLoading = false;
        mainContent.classList.remove("opacity-50", "pointer-events-none");
        loadingIndicator.classList.add("hidden");
      }

      async function fetchData(sheetName) {
        showLoading();
        let data = [];
        try {
          const response = await fetch(`${SCRIPT_URL}?sheet=${sheetName}`);
          if (!response.ok) {
            const errorText = `HTTP error! Status: ${response.status} - ${
              response.statusText || "Unknown error"
            }`;
            console.error("Fetch failed:", errorText);
            throw new Error(errorText);
          }
          data = await response.json();

          if (sheetName === "DATA_KARYAWAN") {
            employeeData = data;
          } else if (sheetName === "REPORT_PELANGGARAN") {
            violationData = data;
          }
          lastUpdatedText.textContent = `Terakhir diperbarui: ${new Date().toLocaleString()}`;
          showToast("Data berhasil diperbarui!", 1500);
        } catch (error) {
          console.error("Error fetching data:", error);
          showToast(
            `Gagal terhubung ke server. Periksa koneksi atau URL Apps Script. Detail: ${error.message}`,
            5000
          );
        } finally {
          hideLoading();
        }
        return data;
      }

      // --- Chart Data Processing Functions ---
      function processChartData(data, fieldName) {
        const counts = {};
        data.forEach((item) => {
          const value = item[fieldName] || "Tidak Diketahui";
          counts[value] = (counts[value] || 0) + 1;
        });
        return {
          labels: Object.keys(counts),
          data: Object.values(counts),
        };
      }

      function processDateData(data, dateFieldName, viewMode) {
        const counts = {};
        data.forEach((item) => {
          const dateString = item[dateFieldName];
          if (dateString) {
            try {
              const date = new Date(dateString);
              let key;
              if (viewMode === "year") {
                key = date.getFullYear().toString();
              } else if (viewMode === "month") {
                key = date.toLocaleString("id-ID", {
                  year: "numeric",
                  month: "short",
                });
              }
              // For 'week', a more complex grouping by week number might be needed.
              // For simplicity, for 'week' view, we can default to daily or monthly.
              // For now, only 'year' and 'month' are fully supported.
              if (key) {
                counts[key] = (counts[key] || 0) + 1;
              }
            } catch (e) {
              console.warn(
                `Invalid date format for ${dateFieldName}: ${dateString}`
              );
            }
          } else {
            counts["Tidak Diketahui"] = (counts["Tidak Diketahui"] || 0) + 1;
          }
        });
        // Sort by year or month
        const sortedKeys = Object.keys(counts).sort((a, b) => {
          if (viewMode === "year") {
            return parseInt(a) - parseInt(b);
          } else if (viewMode === "month") {
            // Custom sort for month names (e.g., Jan 2023, Feb 2023)
            const [monthA, yearA] = a.split(" ");
            const [monthB, yearB] = b.split(" ");
            if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
            const monthOrder = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "Mei",
              "Jun",
              "Jul",
              "Agu",
              "Sep",
              "Okt",
              "Nov",
              "Des",
            ];
            return monthOrder.indexOf(monthA) - monthOrder.indexOf(monthB);
          }
          return 0;
        });
        return {
          labels: sortedKeys,
          data: sortedKeys.map((key) => counts[key]),
        };
      }

      function generateRandomColors(num) {
        const colors = [];
        for (let i = 0; i < num; i++) {
          const r = Math.floor(Math.random() * 200);
          const g = Math.floor(Math.random() * 200);
          const b = Math.floor(Math.random() * 200);
          colors.push(`rgba(${r}, ${g}, ${b}, 0.7)`);
        }
        return colors;
      }

      function createChart(chartId, type, label, chartData, options = {}) {
        const ctx = document.getElementById(chartId);
        if (!ctx) return;

        if (charts[chartId]) {
          charts[chartId].destroy();
        }

        const defaultOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: type === "doughnut" ? "right" : "top",
            },
            title: {
              display: false,
              text: label,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
              },
            },
          },
        };

        // Merge default options with any custom options provided
        const finalOptions = { ...defaultOptions, ...options };

        // For doughnut charts, remove y-axis scale
        if (type === "doughnut") {
          delete finalOptions.scales;
        }

        const backgroundColors = generateRandomColors(chartData.labels.length);
        charts[chartId] = new Chart(ctx.getContext("2d"), {
          type: type,
          data: {
            labels: chartData.labels,
            datasets: [
              {
                label: label,
                data: chartData.data,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map((color) =>
                  color.replace("0.7", "1")
                ),
                borderWidth: 1,
              },
            ],
          },
          options: finalOptions,
        });
      }

      // --- Render Functions for Tabs ---
      async function renderKaryawanCharts() {
        if (employeeData.length === 0) {
          await fetchData("DATA_KARYAWAN");
        }

        if (employeeData.length === 0) {
          karyawanContent.innerHTML = `<div class="text-center py-8 text-gray-500">Tidak ada data karyawan ditemukan untuk membuat grafik.</div>`;
          return;
        }

        // Data Karyawan Charts
        createChart(
          "maritalStatusChart",
          "pie",
          "Status Pernikahan",
          processChartData(employeeData, "MARITAL STATUS")
        );
        createChart(
          "genderChart",
          "doughnut",
          "Jenis Kelamin",
          processChartData(employeeData, "GENDER")
        ); // Doughnut
        createChart(
          "religionChart",
          "bar",
          "Agama",
          processChartData(employeeData, "RELIGION")
        );
        createChart(
          "gradeChart",
          "bar",
          "Grade",
          processChartData(employeeData, "GRADE")
        );
        createChart(
          "departmentChart",
          "bar",
          "Departemen",
          processChartData(employeeData, "DEPARTMENT")
        );
        createChart(
          "positionChart",
          "bar",
          "Posisi",
          processChartData(employeeData, "POSITION")
        );
        createChart(
          "educationChart",
          "bar",
          "Pendidikan",
          processChartData(employeeData, "EDUCATION")
        );
        createChart(
          "pohChart",
          "bar",
          "POH",
          processChartData(employeeData, "POH")
        );
        createChart(
          "statusPohChart",
          "doughnut",
          "Status POH",
          processChartData(employeeData, "STATUS POH")
        ); // Doughnut
        createChart(
          "provinceChart",
          "bar",
          "Provinsi",
          processChartData(employeeData, "PROVINCE")
        );

        // Hiring Date Time Chart
        createChart(
          "hiringDateChart",
          "line",
          "Tanggal Bergabung",
          processDateData(employeeData, "HIRING DATE", currentHiringDateView)
        );
      }

      async function renderSuratPeringatanCharts() {
        if (violationData.length === 0) {
          await fetchData("REPORT_PELANGGARAN");
        }

        if (violationData.length === 0) {
          suratPeringatanContent.innerHTML = `<div class="text-center py-8 text-gray-500">Tidak ada data surat peringatan ditemukan untuk membuat grafik.</div>`;
          return;
        }

        // Surat Peringatan Charts
        createChart(
          "departmentSPChart",
          "bar",
          "Departemen (SP)",
          processChartData(violationData, "DEPARTMENT")
        );
        createChart(
          "positionSPChart",
          "bar",
          "Posisi (SP)",
          processChartData(violationData, "POSITION")
        );
        createChart(
          "sanksiSPChart",
          "pie",
          "Sanksi (SP)",
          processChartData(violationData, "SANKSI")
        );

        // Tanggal Kejadian Time Chart
        createChart(
          "tanggalKejadianSPChart",
          "line",
          "Tanggal Kejadian (SP)",
          processDateData(
            violationData,
            "TANGGAL KEJADIAN",
            currentTanggalKejadianView
          )
        );
      }

      // --- Tab Switching Logic ---
      async function showTab(tabName) {
        activeTab = tabName;

        // Update button styles
        tabKaryawanBtn.classList.remove("active");
        tabSuratPeringatanBtn.classList.remove("active");

        // Hide all content divs
        karyawanContent.classList.add("hidden");
        suratPeringatanContent.classList.add("hidden");

        // Show selected tab content and render charts
        if (tabName === "karyawan") {
          tabKaryawanBtn.classList.add("active");
          karyawanContent.classList.remove("hidden");
          await renderKaryawanCharts();
        } else if (tabName === "surat-peringatan") {
          tabSuratPeringatanBtn.classList.add("active");
          suratPeringatanContent.classList.remove("hidden");
          await renderSuratPeringatanCharts();
        }
      }

      // --- Event Listeners ---
      sidebarToggleBtn.addEventListener("click", showSidebar);
      sidebarBackdrop.addEventListener("click", hideSidebar);

      hiringDateYearBtn.addEventListener("click", () => {
        currentHiringDateView = "year";
        renderKaryawanCharts();
      });
      hiringDateMonthBtn.addEventListener("click", () => {
        currentHiringDateView = "month";
        renderKaryawanCharts();
      });

      tanggalKejadianYearBtn.addEventListener("click", () => {
        currentTanggalKejadianView = "year";
        renderSuratPeringatanCharts();
      });
      tanggalKejadianMonthBtn.addEventListener("click", () => {
        currentTanggalKejadianView = "month";
        renderSuratPeringatanCharts();
      });

      document.addEventListener("DOMContentLoaded", async () => {
        // Fetch both datasets initially
        await Promise.all([
          fetchData("DATA_KARYAWAN"),
          fetchData("REPORT_PELANGGARAN"),
        ]);
        showTab("karyawan"); // Show default tab after data is fetched
      });
    </script>
  </body>
</html>
